@model StudentManagementSystem.ViewModels.AttendanceReportListViewModel
@{
    ViewData["Title"] = "Attendance Reports";
    Layout = "~/Views/Shared/_ModernLayout.cshtml";
}

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">@ViewData["Title"]</h5>
                <a asp-action="Index" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Reports
                </a>
            </div>
            <div class="card-body">
                <!-- Filters -->
                <form method="get" class="mb-4">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="batchId" class="form-label">Batch</label>
                            <select name="batchId" id="batchId" class="form-select">
                                <option value="">All Batches</option>
                                @foreach (var batch in Model.Batches)
                                {
                                    <option value="@batch.Id" selected="@(Model.BatchId == batch.Id)">
                                        @batch.BatchCode - @batch.BatchName
                                    </option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="startDate" class="form-label">Start Date</label>
                            <input type="date" name="startDate" id="startDate" class="form-control" value="@(Model.StartDate?.ToString("yyyy-MM-dd"))">
                        </div>
                        <div class="col-md-3">
                            <label for="endDate" class="form-label">End Date</label>
                            <input type="date" name="endDate" id="endDate" class="form-control" value="@(Model.EndDate?.ToString("yyyy-MM-dd"))">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-filter"></i> Apply Filters
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <a asp-action="AttendanceReport" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Clear Filters
                            </a>
                            <button type="button" class="btn btn-success ms-2" onclick="exportToExcel()">
                                <i class="fas fa-file-excel"></i> Export to Excel
                            </button>
                            <button type="button" class="btn btn-danger ms-2" onclick="exportToPDF()">
                                <i class="fas fa-file-pdf"></i> Export to PDF
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Summary Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h4>@Model.Attendances.Count</h4>
                                <p class="mb-0">Total Records</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h4>@Model.Attendances.Count(a => a.Status == "Present")</h4>
                                <p class="mb-0">Present</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-danger text-white">
                            <div class="card-body text-center">
                                <h4>@Model.Attendances.Count(a => a.Status == "Absent")</h4>
                                <p class="mb-0">Absent</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <h4>@Model.Attendances.Count(a => a.Status == "Late")</h4>
                                <p class="mb-0">Late</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Attendance Rate Chart -->
                @if (Model.Attendances.Any())
                {
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Attendance Rate</h6>
                                </div>
                                <div class="card-body">
                                    @{
                                        var totalRecords = Model.Attendances.Count;
                                        var presentCount = Model.Attendances.Count(a => a.Status == "Present");
                                        var absentCount = Model.Attendances.Count(a => a.Status == "Absent");
                                        var lateCount = Model.Attendances.Count(a => a.Status == "Late");
                                        var presentRate = totalRecords > 0 ? (double)presentCount / totalRecords * 100 : 0;
                                        var absentRate = totalRecords > 0 ? (double)absentCount / totalRecords * 100 : 0;
                                        var lateRate = totalRecords > 0 ? (double)lateCount / totalRecords * 100 : 0;
                                    }
                                    <div class="progress" style="height: 30px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: @presentRate%" aria-valuenow="@presentRate" aria-valuemin="0" aria-valuemax="100">
                                            Present @Math.Round(presentRate, 1)%
                                        </div>
                                        <div class="progress-bar bg-warning" role="progressbar" style="width: @lateRate%" aria-valuenow="@lateRate" aria-valuemin="0" aria-valuemax="100">
                                            Late @Math.Round(lateRate, 1)%
                                        </div>
                                        <div class="progress-bar bg-danger" role="progressbar" style="width: @absentRate%" aria-valuenow="@absentRate" aria-valuemin="0" aria-valuemax="100">
                                            Absent @Math.Round(absentRate, 1)%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                <!-- Data Table -->
                @if (Model.Attendances.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="attendanceReportTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>Date</th>
                                    <th>Student Code</th>
                                    <th>Student Name</th>
                                    <th>Batch Code</th>
                                    <th>Trade</th>
                                    <th>Status</th>
                                    <th>Time In</th>
                                    <th>Time Out</th>
                                    <th>Remarks</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var attendance in Model.Attendances)
                                {
                                    <tr>
                                        <td>@attendance.Date.ToString("dd/MM/yyyy")</td>
                                        <td><strong>@attendance.StudentCode</strong></td>
                                        <td>@attendance.StudentName</td>
                                        <td>@attendance.BatchCode</td>
                                        <td>@attendance.TradeName</td>
                                        <td>
                                            <span class="badge bg-@(attendance.Status == "Present" ? "success" : attendance.Status == "Absent" ? "danger" : attendance.Status == "Late" ? "warning" : "secondary")">
                                                @attendance.Status
                                            </span>
                                        </td>
                                        <td>@(attendance.TimeIn?.ToString(@"hh\:mm") ?? "N/A")</td>
                                        <td>@(attendance.TimeOut?.ToString(@"hh\:mm") ?? "N/A")</td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(attendance.Remarks))
                                            {
                                                <span class="text-muted" title="@attendance.Remarks">
                                                    @(attendance.Remarks.Length > 20 ? attendance.Remarks.Substring(0, 20) + "..." : attendance.Remarks)
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-info" onclick="viewAttendanceDetails('@attendance.Date.ToString("yyyy-MM-dd")', '@attendance.StudentCode', '@attendance.StudentName', '@attendance.BatchCode', '@attendance.Status', '@attendance.Remarks')">
                                                <i class="fas fa-eye"></i> Details
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center py-5">
                        <i class="fas fa-calendar-check fa-4x text-muted mb-3"></i>
                        <h5 class="text-muted">No attendance records found</h5>
                        <p class="text-muted">Try adjusting your filter criteria or check if attendance has been marked.</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Attendance Details Modal -->
<div class="modal fade" id="attendanceDetailsModal" tabindex="-1" aria-labelledby="attendanceDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="attendanceDetailsModalLabel">Attendance Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Date:</strong>
                        <p id="modalDate"></p>
                    </div>
                    <div class="col-md-6">
                        <strong>Student:</strong>
                        <p id="modalStudent"></p>
                    </div>
                    <div class="col-md-6">
                        <strong>Batch:</strong>
                        <p id="modalBatch"></p>
                    </div>
                    <div class="col-md-6">
                        <strong>Status:</strong>
                        <p id="modalStatus"></p>
                    </div>
                    <div class="col-12">
                        <strong>Remarks:</strong>
                        <p id="modalRemarks"></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script>
        $(document).ready(function() {
            $('#attendanceReportTable').DataTable({
                "pageLength": 25,
                "ordering": true,
                "searching": true,
                "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                "order": [[0, "desc"]], // Sort by date descending
                "dom": '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                       '<"row"<"col-sm-12"tr>>' +
                       '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                "language": {
                    "search": "Search attendance:",
                    "lengthMenu": "Show _MENU_ records per page",
                    "info": "Showing _START_ to _END_ of _TOTAL_ records",
                    "infoEmpty": "Showing 0 to 0 of 0 records",
                    "infoFiltered": "(filtered from _MAX_ total records)"
                },
                "columnDefs": [
                    { "orderable": false, "targets": [9] } // Disable sorting for Actions column
                ]
            });
        });

        function viewAttendanceDetails(date, studentCode, studentName, batchCode, status, remarks) {
            $('#modalDate').text(new Date(date).toLocaleDateString());
            $('#modalStudent').text(studentCode + ' - ' + studentName);
            $('#modalBatch').text(batchCode);
            $('#modalStatus').html('<span class="badge bg-' + (status === 'Present' ? 'success' : status === 'Absent' ? 'danger' : status === 'Late' ? 'warning' : 'secondary') + '">' + status + '</span>');
            $('#modalRemarks').text(remarks || 'No remarks');
            $('#attendanceDetailsModal').modal('show');
        }

        function exportToExcel() {
            const baseUrl = '@Url.Action("AttendanceReportCsv", "Reports")';
            const params = new URLSearchParams();
            const batchId = document.getElementById('batchId').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            if (batchId) params.append('batchId', batchId);
            if (startDate) params.append('startDate', startDate);
            if (endDate) params.append('endDate', endDate);
            window.location.href = baseUrl + (params.toString() ? ('?' + params.toString()) : '');
        }

        function exportToPDF() {
            const title = 'Attendance Report';
            const table = document.getElementById('attendanceReportTable');
            const win = window.open('', '_blank');
            win.document.write('<html><head><title>' + title + '</title>');
            win.document.write('<style>body{font-family:Arial,sans-serif;padding:16px;} table{width:100%;border-collapse:collapse} th,td{border:1px solid #ccc;padding:6px;text-align:left}</style>');
            win.document.write('</head><body>');
            win.document.write('<h3>' + title + '</h3>');
            win.document.write(table.outerHTML);
            win.document.write('</body></html>');
            win.document.close();
            win.focus();
            win.print();
        }
    </script>
}

@section Styles {
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
}