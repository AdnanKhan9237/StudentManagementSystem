@model TakeAttendanceViewModel

@{
    ViewData["Title"] = $"Take Attendance - {Model.BatchName}";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-header">
                <div class="page-block">
                    <div class="row align-items-center">
                        <div class="col-md-12">
                            <div class="page-header-title">
                                <h5 class="m-b-10">Take Attendance</h5>
                            </div>
                            <ul class="breadcrumb">
                                <li class="breadcrumb-item">
                                    <a asp-action="Index" asp-controller="Home">
                                        <i class="feather icon-home"></i>
                                    </a>
                                </li>
                                <li class="breadcrumb-item">
                                    <a asp-action="Index" asp-controller="Attendance">Attendance</a>
                                </li>
                                <li class="breadcrumb-item">Take Attendance</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Batch Information -->
    <div class="row">
        <div class="col-12">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h4 class="text-white">@Model.BatchName</h4>
                            <p class="text-white-50 mb-1">
                                <i class="fas fa-code"></i> @Model.BatchCode | 
                                <i class="fas fa-tools"></i> @Model.TradeName
                            </p>
                            <p class="text-white-50 mb-0">
                                <i class="fas fa-calendar-alt"></i> @Model.SessionName
                            </p>
                        </div>
                        <div class="col-md-6 text-right">
                            <h5 class="text-white">@Model.AttendanceDate.ToString("dddd, dd MMMM yyyy")</h5>
                            <p class="text-white-50 mb-1">
                                <i class="fas fa-clock"></i> @Model.TimingName
                            </p>
                            <p class="text-white-50 mb-0">
                                <i class="fas fa-door-open"></i> @Model.RoomName
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance Form -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>Mark Attendance</h5>
                    <div class="float-right">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-success btn-sm" onclick="markAllAs('Present')">
                                <i class="fas fa-check"></i> Mark All Present
                            </button>
                            <button type="button" class="btn btn-danger btn-sm" onclick="markAllAs('Absent')">
                                <i class="fas fa-times"></i> Mark All Absent
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <form asp-action="TakeAttendance" method="post" id="attendanceForm">
                        <input type="hidden" asp-for="BatchId" />
                        <input type="hidden" asp-for="BatchName" />
                        <input type="hidden" asp-for="BatchCode" />
                        <input type="hidden" asp-for="TradeName" />
                        <input type="hidden" asp-for="SessionName" />
                        <input type="hidden" asp-for="TimingName" />
                        <input type="hidden" asp-for="RoomName" />
                        <input type="hidden" asp-for="AttendanceDate" />

                        @if (Model.Students.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="thead-light">
                                        <tr>
                                            <th width="5%">#</th>
                                            <th width="15%">Reg. No.</th>
                                            <th width="25%">Student Name</th>
                                            <th width="15%">Status</th>
                                            <th width="12%">Time In</th>
                                            <th width="12%">Time Out</th>
                                            <th width="16%">Remarks</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @for (int i = 0; i < Model.Students.Count; i++)
                                        {
                                            <tr class="student-row" data-student-id="@Model.Students[i].StudentId">
                                                <td>@(i + 1)</td>
                                                <td>
                                                    <strong>@Model.Students[i].RegistrationNumber</strong>
                                                    <input type="hidden" asp-for="Students[i].StudentId" />
                                                    <input type="hidden" asp-for="Students[i].EnrollmentId" />
                                                    <input type="hidden" asp-for="Students[i].RegistrationNumber" />
                                                    <input type="hidden" asp-for="Students[i].StudentName" />
                                                </td>
                                                <td>@Model.Students[i].StudentName</td>
                                                <td>
                                                    <select asp-for="Students[i].Status" class="form-control form-control-sm status-select">
                                                        <option value="Present">Present</option>
                                                        <option value="Absent">Absent</option>
                                                        <option value="Late">Late</option>
                                                        <option value="Excused">Excused</option>
                                                    </select>
                                                    <span asp-validation-for="Students[i].Status" class="text-danger"></span>
                                                </td>
                                                <td>
                                                    <input asp-for="Students[i].TimeIn" type="time" 
                                                           class="form-control form-control-sm time-input" />
                                                </td>
                                                <td>
                                                    <input asp-for="Students[i].TimeOut" type="time" 
                                                           class="form-control form-control-sm time-input" />
                                                </td>
                                                <td>
                                                    <input asp-for="Students[i].Remarks" 
                                                           class="form-control form-control-sm" 
                                                           placeholder="Optional remarks" />
                                                    <span asp-validation-for="Students[i].Remarks" class="text-danger"></span>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>

                            <!-- Summary Section -->
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>Attendance Summary</h6>
                                            <div class="row text-center">
                                                <div class="col-3">
                                                    <div class="text-success">
                                                        <i class="fas fa-check-circle fa-2x"></i>
                                                        <div class="mt-2">
                                                            <strong id="presentCount">0</strong>
                                                            <br><small>Present</small>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-3">
                                                    <div class="text-danger">
                                                        <i class="fas fa-times-circle fa-2x"></i>
                                                        <div class="mt-2">
                                                            <strong id="absentCount">0</strong>
                                                            <br><small>Absent</small>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-3">
                                                    <div class="text-warning">
                                                        <i class="fas fa-clock fa-2x"></i>
                                                        <div class="mt-2">
                                                            <strong id="lateCount">0</strong>
                                                            <br><small>Late</small>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-3">
                                                    <div class="text-info">
                                                        <i class="fas fa-user-check fa-2x"></i>
                                                        <div class="mt-2">
                                                            <strong id="excusedCount">0</strong>
                                                            <br><small>Excused</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>Actions</h6>
                                            <div class="text-center">
                                                <button type="submit" class="btn btn-success btn-lg">
                                                    <i class="fas fa-save"></i> Save Attendance
                                                </button>
                                                <a asp-action="ViewAttendance" asp-route-batchId="@Model.BatchId" 
                                                   asp-route-date="@Model.AttendanceDate.ToString("yyyy-MM-dd")" 
                                                   class="btn btn-info btn-lg ml-2">
                                                    <i class="fas fa-eye"></i> View
                                                </a>
                                                <a asp-action="Index" class="btn btn-secondary btn-lg ml-2">
                                                    <i class="fas fa-arrow-left"></i> Back
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning text-center">
                                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                                <h5>No Students Found</h5>
                                <p class="mb-0">This batch doesn't have any enrolled students yet.</p>
                                <div class="mt-3">
                                    <a asp-action="Index" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left"></i> Back to Batches
                                    </a>
                                </div>
                            </div>
                        }
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Date Navigation -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h6>Change Date</h6>
                    <form method="get" asp-action="TakeAttendance" class="form-inline">
                        <input type="hidden" name="batchId" value="@Model.BatchId" />
                        <div class="form-group mr-3">
                            <label for="dateInput" class="mr-2">Select Date:</label>
                            <input type="date" id="dateInput" name="date" 
                                   value="@Model.AttendanceDate.ToString("yyyy-MM-dd")" 
                                   class="form-control" />
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-calendar"></i> Load Date
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function() {
            // Update summary counts
            function updateSummary() {
                var presentCount = $('.status-select option[value="Present"]:selected').length;
                var absentCount = $('.status-select option[value="Absent"]:selected').length;
                var lateCount = $('.status-select option[value="Late"]:selected').length;
                var excusedCount = $('.status-select option[value="Excused"]:selected').length;
                
                $('#presentCount').text(presentCount);
                $('#absentCount').text(absentCount);
                $('#lateCount').text(lateCount);
                $('#excusedCount').text(excusedCount);
            }

            // Mark all students with specific status
            window.markAllAs = function(status) {
                $('.status-select').val(status);
                updateSummary();
                
                // Enable/disable time inputs based on status
                $('.status-select').each(function() {
                    var row = $(this).closest('tr');
                    var timeInputs = row.find('.time-input');
                    
                    if (status === 'Absent') {
                        timeInputs.val('').prop('disabled', true);
                    } else {
                        timeInputs.prop('disabled', false);
                        if (status === 'Present' || status === 'Late') {
                            // Set default time in for present/late students
                            var timeIn = row.find('input[name$=".TimeIn"]');
                            if (!timeIn.val()) {
                                var now = new Date();
                                timeIn.val(now.toTimeString().substr(0, 5));
                            }
                        }
                    }
                });
            };

            // Handle status change for individual students
            $('.status-select').change(function() {
                var status = $(this).val();
                var row = $(this).closest('tr');
                var timeInputs = row.find('.time-input');
                
                if (status === 'Absent') {
                    timeInputs.val('').prop('disabled', true);
                } else {
                    timeInputs.prop('disabled', false);
                    if (status === 'Present' || status === 'Late') {
                        var timeIn = row.find('input[name$=".TimeIn"]');
                        if (!timeIn.val()) {
                            var now = new Date();
                            timeIn.val(now.toTimeString().substr(0, 5));
                        }
                    }
                }
                
                updateSummary();
            });

            // Initial summary update
            updateSummary();

            // Add row highlighting on hover
            $('.student-row').hover(
                function() {
                    $(this).addClass('table-active');
                },
                function() {
                    $(this).removeClass('table-active');
                }
            );

            // Form validation before submit
            $('#attendanceForm').submit(function(e) {
                var hasValidation = true;
                
                $('.status-select').each(function() {
                    if (!$(this).val()) {
                        hasValidation = false;
                        $(this).addClass('is-invalid');
                    } else {
                        $(this).removeClass('is-invalid');
                    }
                });
                
                if (!hasValidation) {
                    e.preventDefault();
                    alert('Please select attendance status for all students.');
                    return false;
                }
                
                return confirm('Are you sure you want to save this attendance record? This will replace any existing attendance for this date.');
            });
        });
    </script>
}